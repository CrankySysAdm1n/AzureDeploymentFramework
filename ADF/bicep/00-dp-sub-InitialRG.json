{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1.14562",
      "templateHash": "18037890064404049771"
    }
  },
  "parameters": {
    "Prefix": {
      "type": "string",
      "allowedValues": [
        "AEU2",
        "ACU1",
        "AWU2",
        "AEU1"
      ]
    },
    "Environment": {
      "type": "string",
      "allowedValues": [
        "I",
        "D",
        "T",
        "U",
        "P",
        "S",
        "G",
        "A"
      ]
    },
    "DeploymentID": {
      "type": "string",
      "allowedValues": [
        "0",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9"
      ]
    },
    "Stage": {
      "type": "object"
    },
    "Extensions": {
      "type": "object"
    },
    "Global": {
      "type": "object"
    },
    "DeploymentInfo": {
      "type": "object"
    },
    "vmAdminPassword": {
      "type": "secureString"
    },
    "devOpsPat": {
      "type": "secureString"
    },
    "sshPublic": {
      "type": "secureString"
    }
  },
  "functions": [],
  "variables": {
    "Deployment": "[format('{0}-{1}-{2}-{3}{4}', parameters('Prefix'), parameters('Global').OrgName, parameters('Global').Appname, parameters('Environment'), parameters('DeploymentID'))]"
  },
  "resources": [
    {
      "condition": "[and(equals(parameters('Stage').RG, 1), not(equals(format('{0}{1}', parameters('DeploymentID'), parameters('Environment')), 'G0')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('dp{0}-RG', variables('Deployment'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "DeploymentID": {
            "value": "[parameters('DeploymentID')]"
          },
          "DeploymentInfo": {
            "value": "[parameters('DeploymentInfo')]"
          },
          "Environment": {
            "value": "[parameters('Environment')]"
          },
          "Extensions": {
            "value": "[parameters('Extensions')]"
          },
          "Global": {
            "value": "[parameters('Global')]"
          },
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "Stage": {
            "value": "[parameters('Stage')]"
          },
          "devOpsPat": {
            "value": "[parameters('devOpsPat')]"
          },
          "sshPublic": {
            "value": "[parameters('sshPublic')]"
          },
          "vmAdminPassword": {
            "value": "[parameters('vmAdminPassword')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1.14562",
              "templateHash": "12130810722369817975"
            }
          },
          "parameters": {
            "Prefix": {
              "type": "string",
              "defaultValue": "ACU1",
              "allowedValues": [
                "AEU2",
                "ACU1",
                "AWU2",
                "AEU1"
              ]
            },
            "Environment": {
              "type": "string",
              "allowedValues": [
                "G",
                "I",
                "D",
                "T",
                "U",
                "P",
                "S",
                "A"
              ]
            },
            "DeploymentID": {
              "type": "string",
              "allowedValues": [
                "0",
                "1",
                "2",
                "3",
                "4",
                "5",
                "6",
                "7",
                "8",
                "9"
              ]
            },
            "Stage": {
              "type": "object"
            },
            "Extensions": {
              "type": "object"
            },
            "Global": {
              "type": "object"
            },
            "DeploymentInfo": {
              "type": "object"
            },
            "vmAdminPassword": {
              "type": "secureString"
            },
            "devOpsPat": {
              "type": "secureString"
            },
            "sshPublic": {
              "type": "secureString"
            }
          },
          "functions": [],
          "variables": {
            "copy": [
              {
                "name": "identity",
                "count": "[length(parameters('DeploymentInfo').uaiInfo)]",
                "input": {
                  "name": "[parameters('DeploymentInfo').uaiInfo[copyIndex('identity')].name]",
                  "match": "[or(equals(parameters('Global').cn, '.'), contains(parameters('Global').cn, parameters('DeploymentInfo').uaiInfo[copyIndex('identity')].name))]"
                }
              }
            ],
            "enviro": "[format('{0}{1}', parameters('Environment'), parameters('DeploymentID'))]",
            "deployment": "[format('{0}-{1}-{2}-{3}', parameters('Prefix'), parameters('Global').orgname, parameters('Global').AppName, variables('enviro'))]",
            "rg": "[format('{0}-{1}-{2}-RG-{3}', parameters('Prefix'), parameters('Global').orgname, parameters('Global').AppName, variables('enviro'))]",
            "locationlookup": {
              "AZE2": "eastus2",
              "AZC1": "centralus",
              "AEU2": "eastus2",
              "ACU1": "centralus"
            },
            "location": "[variables('locationlookup')[parameters('Prefix')]]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-01-01",
              "name": "[variables('rg')]",
              "location": "[variables('location')]",
              "properties": {}
            },
            {
              "condition": "[variables('identity')[copyIndex()].match]",
              "copy": {
                "name": "UAI",
                "count": "[length(variables('identity'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "[format('dp-uai-{0}', variables('identity')[copyIndex()].name)]",
              "resourceGroup": "[variables('rg')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "uai": {
                    "value": "[variables('identity')[copyIndex()]]"
                  },
                  "deployment": {
                    "value": "[variables('deployment')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1.14562",
                      "templateHash": "11924193899864872894"
                    }
                  },
                  "parameters": {
                    "uai": {
                      "type": "object"
                    },
                    "deployment": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                      "apiVersion": "2018-11-30",
                      "name": "[format('{0}-uai{1}', parameters('deployment'), parameters('uai').name)]",
                      "location": "[resourceGroup().location]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rg'))]"
              ]
            }
          ],
          "outputs": {
            "enviro": {
              "type": "string",
              "value": "[variables('enviro')]"
            },
            "deployment": {
              "type": "string",
              "value": "[variables('deployment')]"
            },
            "location": {
              "type": "string",
              "value": "[variables('location')]"
            }
          }
        }
      }
    },
    {
      "condition": "[equals(parameters('Stage').RBAC, 1)]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('dp{0}-RBAC', variables('Deployment'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "DeploymentID": {
            "value": "[parameters('DeploymentID')]"
          },
          "DeploymentInfo": {
            "value": "[parameters('DeploymentInfo')]"
          },
          "Environment": {
            "value": "[parameters('Environment')]"
          },
          "Extensions": {
            "value": "[parameters('Extensions')]"
          },
          "Global": {
            "value": "[parameters('Global')]"
          },
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "Stage": {
            "value": "[parameters('Stage')]"
          },
          "devOpsPat": {
            "value": "[parameters('devOpsPat')]"
          },
          "sshPublic": {
            "value": "[parameters('sshPublic')]"
          },
          "vmAdminPassword": {
            "value": "[parameters('vmAdminPassword')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1.14562",
              "templateHash": "5116602584506713576"
            }
          },
          "parameters": {
            "Prefix": {
              "type": "string",
              "allowedValues": [
                "AEU2",
                "ACU1",
                "AWU2",
                "AEU1"
              ]
            },
            "Environment": {
              "type": "string",
              "allowedValues": [
                "I",
                "D",
                "T",
                "U",
                "P",
                "S",
                "G",
                "A"
              ]
            },
            "DeploymentID": {
              "type": "string",
              "allowedValues": [
                "0",
                "1",
                "2",
                "3",
                "4",
                "5",
                "6",
                "7",
                "8",
                "9"
              ]
            },
            "Stage": {
              "type": "object"
            },
            "Extensions": {
              "type": "object"
            },
            "Global": {
              "type": "object"
            },
            "DeploymentInfo": {
              "type": "object"
            },
            "vmAdminPassword": {
              "type": "secureString"
            },
            "devOpsPat": {
              "type": "secureString"
            },
            "sshPublic": {
              "type": "secureString"
            }
          },
          "functions": [],
          "variables": {
            "copy": [
              {
                "name": "sps",
                "count": "[length(variables('SPInfo'))]",
                "input": {
                  "RBAC": "[variables('SPInfo')[copyIndex('sps')].RBAC]",
                  "name": "[replace(replace(replace(variables('SPInfo')[copyIndex('sps')].Name, '{GHProject}', parameters('Global').GHProject), '{ADOProject}', parameters('Global').ADOProject), '{RGNAME}', variables('rg'))]"
                }
              }
            ],
            "enviro": "[format('{0}{1}', parameters('Environment'), parameters('DeploymentID'))]",
            "deployment": "[format('{0}-{1}-{2}-{3}', parameters('Prefix'), parameters('Global').orgname, parameters('Global').Appname, variables('enviro'))]",
            "rg": "[format('{0}-{1}-{2}-RG-{3}', parameters('Prefix'), parameters('Global').orgname, parameters('Global').Appname, variables('enviro'))]",
            "locationlookup": {
              "AZE2": "eastus2",
              "AZC1": "centralus",
              "AEU2": "eastus2",
              "ACU1": "centralus"
            },
            "location": "[variables('locationlookup')[parameters('Prefix')]]",
            "roleslookup": "[json(parameters('Global').RolesLookup)]",
            "rolesgrouplookup": "[json(parameters('Global').RolesGroupsLookup)]",
            "uaiinfo": "[if(contains(parameters('DeploymentInfo'), 'uaiinfo'), parameters('DeploymentInfo').uaiinfo, createArray())]",
            "rolesInfo": "[if(contains(parameters('DeploymentInfo'), 'rolesInfo'), parameters('DeploymentInfo').rolesInfo, createArray())]",
            "SPInfo": "[if(contains(parameters('DeploymentInfo'), 'SPInfo'), parameters('DeploymentInfo').SPInfo, createArray())]"
          },
          "resources": [
            {
              "copy": {
                "name": "UAI",
                "count": "[length(variables('uaiinfo'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "[format('dp-rbac-uai-{0}', if(equals(length(variables('uaiinfo')), 0), 'na', variables('uaiinfo')[copyIndex()].name))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Deployment": {
                    "value": "[variables('deployment')]"
                  },
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "rgName": {
                    "value": "[variables('rg')]"
                  },
                  "Enviro": {
                    "value": "[variables('enviro')]"
                  },
                  "Global": {
                    "value": "[parameters('Global')]"
                  },
                  "rolesGroupsLookup": {
                    "value": "[variables('rolesgrouplookup')]"
                  },
                  "rolesLookup": {
                    "value": "[variables('roleslookup')]"
                  },
                  "roleInfo": {
                    "value": "[variables('uaiinfo')[copyIndex()]]"
                  },
                  "providerPath": {
                    "value": "Microsoft.ManagedIdentity/userAssignedIdentities"
                  },
                  "namePrefix": {
                    "value": "-uai"
                  },
                  "providerAPI": {
                    "value": "2018-11-30"
                  },
                  "principalType": {
                    "value": "ServicePrincipal"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1.14562",
                      "templateHash": "667383927536226538"
                    }
                  },
                  "parameters": {
                    "Deployment": {
                      "type": "string"
                    },
                    "Prefix": {
                      "type": "string"
                    },
                    "rgName": {
                      "type": "string"
                    },
                    "Enviro": {
                      "type": "string"
                    },
                    "Global": {
                      "type": "object"
                    },
                    "rolesLookup": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "rolesGroupsLookup": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "roleInfo": {
                      "type": "object"
                    },
                    "providerPath": {
                      "type": "string"
                    },
                    "namePrefix": {
                      "type": "string"
                    },
                    "providerAPI": {
                      "type": "string"
                    },
                    "principalType": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "functions": [],
                  "variables": {
                    "copy": [
                      {
                        "name": "roleAssignment",
                        "count": "[length(range(0, length(parameters('roleInfo').RBAC)))]",
                        "input": {
                          "SourceSubscriptionID": "[subscription().subscriptionId]",
                          "SourceRG": "[parameters('rgName')]",
                          "RoleName": "[parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Name]",
                          "RoleID": "[parameters('rolesGroupsLookup')[parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Name].Id]",
                          "DestSubscriptionID": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'SubscriptionID'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].SubScriptionID, subscription().subscriptionId)]",
                          "DestSubscription": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'SubscriptionID'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].SubScriptionID, subscription().id)]",
                          "DestRG": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'RG'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].RG, parameters('Enviro'))]",
                          "DestPrefix": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Prefix'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Prefix, parameters('Prefix'))]",
                          "DestApp": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Tenant'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Tenant, parameters('Global').AppName)]",
                          "principalType": "[parameters('principalType')]",
                          "GUID": "[guid(subscription().subscriptionId, parameters('rgName'), parameters('roleInfo').Name, parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Name, if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'SubscriptionID'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].SubScriptionID, subscription().subscriptionId), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'RG'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].RG, parameters('Enviro')), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Prefix'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Prefix, parameters('Prefix')), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Tenant'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Tenant, parameters('Global').AppName))]",
                          "FriendlyName": "[format('source: {0} --> {1} --> {2} --> destination: {3}-{4}-{5}', parameters('rgName'), parameters('roleInfo').Name, parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Name, if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Prefix'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Prefix, parameters('Prefix')), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'RG'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].RG, parameters('Enviro')), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Tenant'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Tenant, parameters('Global').AppName))]"
                        }
                      }
                    ]
                  },
                  "resources": [
                    {
                      "condition": "[equals(parameters('Enviro'), 'G0')]",
                      "copy": {
                        "name": "RBACRASUB",
                        "count": "[length(variables('roleAssignment'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[replace(format('dp-rbac-all-ra-{0}-{1}', parameters('roleInfo').name, copyIndex()), '@', '_')]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "description": {
                            "value": "[parameters('roleInfo').name]"
                          },
                          "name": {
                            "value": "[variables('roleAssignment')[copyIndex()].GUID]"
                          },
                          "roledescription": {
                            "value": "[variables('roleAssignment')[copyIndex()].RoleName]"
                          },
                          "roleDefinitionId": {
                            "value": "[concat(variables('roleAssignment')[copyIndex()].DestSubscription, '/providers/Microsoft.Authorization/roleDefinitions/', variables('roleAssignment')[copyIndex()].RoleID)]"
                          },
                          "principalType": {
                            "value": "[variables('roleAssignment')[copyIndex()].principalType]"
                          },
                          "principalId": {
                            "value": "[if(equals(parameters('providerPath'), 'guid'), parameters('roleInfo').name, if(equals(length(parameters('providerPath')), 0), parameters('rolesLookup')[parameters('roleInfo').name], reference(concat(variables('roleAssignment')[copyIndex()].DestSubscription, '/resourceGroups/', variables('roleAssignment')[copyIndex()].SourceRG, '/providers/', parameters('providerPath'), '/', parameters('Deployment'), parameters('namePrefix'), parameters('roleInfo').Name), parameters('providerAPI')).principalId))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.1.14562",
                              "templateHash": "2591321979364162724"
                            }
                          },
                          "parameters": {
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            },
                            "description": {
                              "type": "string"
                            },
                            "roledescription": {
                              "type": "string"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[parameters('name')]",
                              "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalType": "[parameters('principalType')]",
                                "principalId": "[parameters('principalId')]"
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('Enviro'), 'G0'))]",
                      "copy": {
                        "name": "RBACRARG",
                        "count": "[length(variables('roleAssignment'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[replace(format('dp-rbac-all-ra-{0}-{1}', parameters('roleInfo').name, copyIndex()), '@', '_')]",
                      "subscriptionId": "[variables('roleAssignment')[copyIndex()].DestSubscriptionID]",
                      "resourceGroup": "[concat(variables('roleAssignment')[copyIndex()].DestPrefix, '-', parameters('Global').OrgName, '-', variables('roleAssignment')[copyIndex()].DestApp, '-RG-', variables('roleAssignment')[copyIndex()].DestRG)]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "description": {
                            "value": "[parameters('roleInfo').name]"
                          },
                          "name": {
                            "value": "[variables('roleAssignment')[copyIndex()].GUID]"
                          },
                          "roledescription": {
                            "value": "[variables('roleAssignment')[copyIndex()].RoleName]"
                          },
                          "roleDefinitionId": {
                            "value": "[concat(variables('roleAssignment')[copyIndex()].DestSubscription, '/providers/Microsoft.Authorization/roleDefinitions/', variables('roleAssignment')[copyIndex()].RoleID)]"
                          },
                          "principalType": {
                            "value": "[variables('roleAssignment')[copyIndex()].principalType]"
                          },
                          "principalId": {
                            "value": "[if(equals(parameters('providerPath'), 'guid'), parameters('roleInfo').name, if(equals(length(parameters('providerPath')), 0), parameters('rolesLookup')[parameters('roleInfo').name], reference(concat(variables('roleAssignment')[copyIndex()].DestSubscription, '/resourceGroups/', variables('roleAssignment')[copyIndex()].SourceRG, '/providers/', parameters('providerPath'), '/', parameters('Deployment'), parameters('namePrefix'), parameters('roleInfo').Name), parameters('providerAPI')).principalId))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.1.14562",
                              "templateHash": "569588579880189143"
                            }
                          },
                          "parameters": {
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            },
                            "description": {
                              "type": "string"
                            },
                            "roledescription": {
                              "type": "string"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[parameters('name')]",
                              "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalType": "[parameters('principalType')]",
                                "principalId": "[parameters('principalId')]"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "RoleAssignments": {
                      "type": "array",
                      "value": "[variables('roleAssignment')]"
                    }
                  }
                }
              }
            },
            {
              "copy": {
                "name": "ROLES",
                "count": "[length(variables('rolesInfo'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "[format('dp-rbac-role-{0}', if(equals(length(variables('rolesInfo')), 0), 'na', variables('rolesInfo')[copyIndex()].name))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Deployment": {
                    "value": "[variables('deployment')]"
                  },
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "rgName": {
                    "value": "[variables('rg')]"
                  },
                  "Enviro": {
                    "value": "[variables('enviro')]"
                  },
                  "Global": {
                    "value": "[parameters('Global')]"
                  },
                  "rolesGroupsLookup": {
                    "value": "[variables('rolesgrouplookup')]"
                  },
                  "rolesLookup": {
                    "value": "[variables('roleslookup')]"
                  },
                  "roleInfo": {
                    "value": "[variables('rolesInfo')[copyIndex()]]"
                  },
                  "providerPath": {
                    "value": ""
                  },
                  "namePrefix": {
                    "value": ""
                  },
                  "providerAPI": {
                    "value": ""
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1.14562",
                      "templateHash": "667383927536226538"
                    }
                  },
                  "parameters": {
                    "Deployment": {
                      "type": "string"
                    },
                    "Prefix": {
                      "type": "string"
                    },
                    "rgName": {
                      "type": "string"
                    },
                    "Enviro": {
                      "type": "string"
                    },
                    "Global": {
                      "type": "object"
                    },
                    "rolesLookup": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "rolesGroupsLookup": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "roleInfo": {
                      "type": "object"
                    },
                    "providerPath": {
                      "type": "string"
                    },
                    "namePrefix": {
                      "type": "string"
                    },
                    "providerAPI": {
                      "type": "string"
                    },
                    "principalType": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "functions": [],
                  "variables": {
                    "copy": [
                      {
                        "name": "roleAssignment",
                        "count": "[length(range(0, length(parameters('roleInfo').RBAC)))]",
                        "input": {
                          "SourceSubscriptionID": "[subscription().subscriptionId]",
                          "SourceRG": "[parameters('rgName')]",
                          "RoleName": "[parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Name]",
                          "RoleID": "[parameters('rolesGroupsLookup')[parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Name].Id]",
                          "DestSubscriptionID": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'SubscriptionID'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].SubScriptionID, subscription().subscriptionId)]",
                          "DestSubscription": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'SubscriptionID'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].SubScriptionID, subscription().id)]",
                          "DestRG": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'RG'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].RG, parameters('Enviro'))]",
                          "DestPrefix": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Prefix'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Prefix, parameters('Prefix'))]",
                          "DestApp": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Tenant'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Tenant, parameters('Global').AppName)]",
                          "principalType": "[parameters('principalType')]",
                          "GUID": "[guid(subscription().subscriptionId, parameters('rgName'), parameters('roleInfo').Name, parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Name, if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'SubscriptionID'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].SubScriptionID, subscription().subscriptionId), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'RG'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].RG, parameters('Enviro')), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Prefix'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Prefix, parameters('Prefix')), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Tenant'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Tenant, parameters('Global').AppName))]",
                          "FriendlyName": "[format('source: {0} --> {1} --> {2} --> destination: {3}-{4}-{5}', parameters('rgName'), parameters('roleInfo').Name, parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Name, if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Prefix'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Prefix, parameters('Prefix')), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'RG'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].RG, parameters('Enviro')), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Tenant'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Tenant, parameters('Global').AppName))]"
                        }
                      }
                    ]
                  },
                  "resources": [
                    {
                      "condition": "[equals(parameters('Enviro'), 'G0')]",
                      "copy": {
                        "name": "RBACRASUB",
                        "count": "[length(variables('roleAssignment'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[replace(format('dp-rbac-all-ra-{0}-{1}', parameters('roleInfo').name, copyIndex()), '@', '_')]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "description": {
                            "value": "[parameters('roleInfo').name]"
                          },
                          "name": {
                            "value": "[variables('roleAssignment')[copyIndex()].GUID]"
                          },
                          "roledescription": {
                            "value": "[variables('roleAssignment')[copyIndex()].RoleName]"
                          },
                          "roleDefinitionId": {
                            "value": "[concat(variables('roleAssignment')[copyIndex()].DestSubscription, '/providers/Microsoft.Authorization/roleDefinitions/', variables('roleAssignment')[copyIndex()].RoleID)]"
                          },
                          "principalType": {
                            "value": "[variables('roleAssignment')[copyIndex()].principalType]"
                          },
                          "principalId": {
                            "value": "[if(equals(parameters('providerPath'), 'guid'), parameters('roleInfo').name, if(equals(length(parameters('providerPath')), 0), parameters('rolesLookup')[parameters('roleInfo').name], reference(concat(variables('roleAssignment')[copyIndex()].DestSubscription, '/resourceGroups/', variables('roleAssignment')[copyIndex()].SourceRG, '/providers/', parameters('providerPath'), '/', parameters('Deployment'), parameters('namePrefix'), parameters('roleInfo').Name), parameters('providerAPI')).principalId))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.1.14562",
                              "templateHash": "2591321979364162724"
                            }
                          },
                          "parameters": {
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            },
                            "description": {
                              "type": "string"
                            },
                            "roledescription": {
                              "type": "string"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[parameters('name')]",
                              "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalType": "[parameters('principalType')]",
                                "principalId": "[parameters('principalId')]"
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('Enviro'), 'G0'))]",
                      "copy": {
                        "name": "RBACRARG",
                        "count": "[length(variables('roleAssignment'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[replace(format('dp-rbac-all-ra-{0}-{1}', parameters('roleInfo').name, copyIndex()), '@', '_')]",
                      "subscriptionId": "[variables('roleAssignment')[copyIndex()].DestSubscriptionID]",
                      "resourceGroup": "[concat(variables('roleAssignment')[copyIndex()].DestPrefix, '-', parameters('Global').OrgName, '-', variables('roleAssignment')[copyIndex()].DestApp, '-RG-', variables('roleAssignment')[copyIndex()].DestRG)]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "description": {
                            "value": "[parameters('roleInfo').name]"
                          },
                          "name": {
                            "value": "[variables('roleAssignment')[copyIndex()].GUID]"
                          },
                          "roledescription": {
                            "value": "[variables('roleAssignment')[copyIndex()].RoleName]"
                          },
                          "roleDefinitionId": {
                            "value": "[concat(variables('roleAssignment')[copyIndex()].DestSubscription, '/providers/Microsoft.Authorization/roleDefinitions/', variables('roleAssignment')[copyIndex()].RoleID)]"
                          },
                          "principalType": {
                            "value": "[variables('roleAssignment')[copyIndex()].principalType]"
                          },
                          "principalId": {
                            "value": "[if(equals(parameters('providerPath'), 'guid'), parameters('roleInfo').name, if(equals(length(parameters('providerPath')), 0), parameters('rolesLookup')[parameters('roleInfo').name], reference(concat(variables('roleAssignment')[copyIndex()].DestSubscription, '/resourceGroups/', variables('roleAssignment')[copyIndex()].SourceRG, '/providers/', parameters('providerPath'), '/', parameters('Deployment'), parameters('namePrefix'), parameters('roleInfo').Name), parameters('providerAPI')).principalId))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.1.14562",
                              "templateHash": "569588579880189143"
                            }
                          },
                          "parameters": {
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            },
                            "description": {
                              "type": "string"
                            },
                            "roledescription": {
                              "type": "string"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[parameters('name')]",
                              "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalType": "[parameters('principalType')]",
                                "principalId": "[parameters('principalId')]"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "RoleAssignments": {
                      "type": "array",
                      "value": "[variables('roleAssignment')]"
                    }
                  }
                }
              }
            },
            {
              "copy": {
                "name": "SP",
                "count": "[length(variables('sps'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "[format('dp-rbac-sp-{0}', if(equals(length(variables('sps')), 0), 'na', variables('sps')[copyIndex()].name))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Deployment": {
                    "value": "[variables('deployment')]"
                  },
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "rgName": {
                    "value": "[variables('rg')]"
                  },
                  "Enviro": {
                    "value": "[variables('enviro')]"
                  },
                  "Global": {
                    "value": "[parameters('Global')]"
                  },
                  "rolesGroupsLookup": {
                    "value": "[variables('rolesgrouplookup')]"
                  },
                  "rolesLookup": {
                    "value": "[variables('roleslookup')]"
                  },
                  "roleInfo": {
                    "value": "[variables('sps')[copyIndex()]]"
                  },
                  "providerPath": {
                    "value": ""
                  },
                  "namePrefix": {
                    "value": ""
                  },
                  "providerAPI": {
                    "value": ""
                  },
                  "principalType": {
                    "value": "ServicePrincipal"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1.14562",
                      "templateHash": "667383927536226538"
                    }
                  },
                  "parameters": {
                    "Deployment": {
                      "type": "string"
                    },
                    "Prefix": {
                      "type": "string"
                    },
                    "rgName": {
                      "type": "string"
                    },
                    "Enviro": {
                      "type": "string"
                    },
                    "Global": {
                      "type": "object"
                    },
                    "rolesLookup": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "rolesGroupsLookup": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "roleInfo": {
                      "type": "object"
                    },
                    "providerPath": {
                      "type": "string"
                    },
                    "namePrefix": {
                      "type": "string"
                    },
                    "providerAPI": {
                      "type": "string"
                    },
                    "principalType": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "functions": [],
                  "variables": {
                    "copy": [
                      {
                        "name": "roleAssignment",
                        "count": "[length(range(0, length(parameters('roleInfo').RBAC)))]",
                        "input": {
                          "SourceSubscriptionID": "[subscription().subscriptionId]",
                          "SourceRG": "[parameters('rgName')]",
                          "RoleName": "[parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Name]",
                          "RoleID": "[parameters('rolesGroupsLookup')[parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Name].Id]",
                          "DestSubscriptionID": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'SubscriptionID'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].SubScriptionID, subscription().subscriptionId)]",
                          "DestSubscription": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'SubscriptionID'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].SubScriptionID, subscription().id)]",
                          "DestRG": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'RG'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].RG, parameters('Enviro'))]",
                          "DestPrefix": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Prefix'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Prefix, parameters('Prefix'))]",
                          "DestApp": "[if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Tenant'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Tenant, parameters('Global').AppName)]",
                          "principalType": "[parameters('principalType')]",
                          "GUID": "[guid(subscription().subscriptionId, parameters('rgName'), parameters('roleInfo').Name, parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Name, if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'SubscriptionID'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].SubScriptionID, subscription().subscriptionId), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'RG'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].RG, parameters('Enviro')), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Prefix'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Prefix, parameters('Prefix')), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Tenant'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Tenant, parameters('Global').AppName))]",
                          "FriendlyName": "[format('source: {0} --> {1} --> {2} --> destination: {3}-{4}-{5}', parameters('rgName'), parameters('roleInfo').Name, parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Name, if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Prefix'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Prefix, parameters('Prefix')), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'RG'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].RG, parameters('Enviro')), if(contains(parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]], 'Tenant'), parameters('roleInfo').RBAC[range(0, length(parameters('roleInfo').RBAC))[copyIndex('roleAssignment')]].Tenant, parameters('Global').AppName))]"
                        }
                      }
                    ]
                  },
                  "resources": [
                    {
                      "condition": "[equals(parameters('Enviro'), 'G0')]",
                      "copy": {
                        "name": "RBACRASUB",
                        "count": "[length(variables('roleAssignment'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[replace(format('dp-rbac-all-ra-{0}-{1}', parameters('roleInfo').name, copyIndex()), '@', '_')]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "description": {
                            "value": "[parameters('roleInfo').name]"
                          },
                          "name": {
                            "value": "[variables('roleAssignment')[copyIndex()].GUID]"
                          },
                          "roledescription": {
                            "value": "[variables('roleAssignment')[copyIndex()].RoleName]"
                          },
                          "roleDefinitionId": {
                            "value": "[concat(variables('roleAssignment')[copyIndex()].DestSubscription, '/providers/Microsoft.Authorization/roleDefinitions/', variables('roleAssignment')[copyIndex()].RoleID)]"
                          },
                          "principalType": {
                            "value": "[variables('roleAssignment')[copyIndex()].principalType]"
                          },
                          "principalId": {
                            "value": "[if(equals(parameters('providerPath'), 'guid'), parameters('roleInfo').name, if(equals(length(parameters('providerPath')), 0), parameters('rolesLookup')[parameters('roleInfo').name], reference(concat(variables('roleAssignment')[copyIndex()].DestSubscription, '/resourceGroups/', variables('roleAssignment')[copyIndex()].SourceRG, '/providers/', parameters('providerPath'), '/', parameters('Deployment'), parameters('namePrefix'), parameters('roleInfo').Name), parameters('providerAPI')).principalId))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.1.14562",
                              "templateHash": "2591321979364162724"
                            }
                          },
                          "parameters": {
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            },
                            "description": {
                              "type": "string"
                            },
                            "roledescription": {
                              "type": "string"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[parameters('name')]",
                              "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalType": "[parameters('principalType')]",
                                "principalId": "[parameters('principalId')]"
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('Enviro'), 'G0'))]",
                      "copy": {
                        "name": "RBACRARG",
                        "count": "[length(variables('roleAssignment'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[replace(format('dp-rbac-all-ra-{0}-{1}', parameters('roleInfo').name, copyIndex()), '@', '_')]",
                      "subscriptionId": "[variables('roleAssignment')[copyIndex()].DestSubscriptionID]",
                      "resourceGroup": "[concat(variables('roleAssignment')[copyIndex()].DestPrefix, '-', parameters('Global').OrgName, '-', variables('roleAssignment')[copyIndex()].DestApp, '-RG-', variables('roleAssignment')[copyIndex()].DestRG)]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "description": {
                            "value": "[parameters('roleInfo').name]"
                          },
                          "name": {
                            "value": "[variables('roleAssignment')[copyIndex()].GUID]"
                          },
                          "roledescription": {
                            "value": "[variables('roleAssignment')[copyIndex()].RoleName]"
                          },
                          "roleDefinitionId": {
                            "value": "[concat(variables('roleAssignment')[copyIndex()].DestSubscription, '/providers/Microsoft.Authorization/roleDefinitions/', variables('roleAssignment')[copyIndex()].RoleID)]"
                          },
                          "principalType": {
                            "value": "[variables('roleAssignment')[copyIndex()].principalType]"
                          },
                          "principalId": {
                            "value": "[if(equals(parameters('providerPath'), 'guid'), parameters('roleInfo').name, if(equals(length(parameters('providerPath')), 0), parameters('rolesLookup')[parameters('roleInfo').name], reference(concat(variables('roleAssignment')[copyIndex()].DestSubscription, '/resourceGroups/', variables('roleAssignment')[copyIndex()].SourceRG, '/providers/', parameters('providerPath'), '/', parameters('Deployment'), parameters('namePrefix'), parameters('roleInfo').Name), parameters('providerAPI')).principalId))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.1.14562",
                              "templateHash": "569588579880189143"
                            }
                          },
                          "parameters": {
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            },
                            "description": {
                              "type": "string"
                            },
                            "roledescription": {
                              "type": "string"
                            }
                          },
                          "functions": [],
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[parameters('name')]",
                              "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalType": "[parameters('principalType')]",
                                "principalId": "[parameters('principalId')]"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "RoleAssignments": {
                      "type": "array",
                      "value": "[variables('roleAssignment')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "enviro": {
              "type": "string",
              "value": "[variables('enviro')]"
            },
            "deployment": {
              "type": "string",
              "value": "[variables('deployment')]"
            },
            "location": {
              "type": "string",
              "value": "[variables('location')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('dp{0}-RG', variables('Deployment')))]"
      ]
    },
    {
      "condition": "[and(contains(parameters('Stage'), 'RoleDefinition'), equals(parameters('Stage').RoleDefinition, 1))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('dp{0}-RoleDefinition', variables('Deployment'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "DeploymentID": {
            "value": "[parameters('DeploymentID')]"
          },
          "DeploymentInfo": {
            "value": "[parameters('DeploymentInfo')]"
          },
          "Environment": {
            "value": "[parameters('Environment')]"
          },
          "Extensions": {
            "value": "[parameters('Extensions')]"
          },
          "Global": {
            "value": "[parameters('Global')]"
          },
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "Stage": {
            "value": "[parameters('Stage')]"
          },
          "devOpsPat": {
            "value": "[parameters('devOpsPat')]"
          },
          "sshPublic": {
            "value": "[parameters('sshPublic')]"
          },
          "vmAdminPassword": {
            "value": "[parameters('vmAdminPassword')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1.14562",
              "templateHash": "8294654292147711544"
            }
          },
          "parameters": {
            "Prefix": {
              "type": "string",
              "allowedValues": [
                "AEU2",
                "ACU1",
                "AWU2",
                "AEU1"
              ]
            },
            "Environment": {
              "type": "string",
              "allowedValues": [
                "I",
                "D",
                "T",
                "U",
                "P",
                "S",
                "G",
                "A"
              ]
            },
            "DeploymentID": {
              "type": "string",
              "allowedValues": [
                "0",
                "1",
                "2",
                "3",
                "4",
                "5",
                "6",
                "7",
                "8",
                "9"
              ]
            },
            "Stage": {
              "type": "object"
            },
            "Extensions": {
              "type": "object"
            },
            "Global": {
              "type": "object"
            },
            "DeploymentInfo": {
              "type": "object"
            },
            "vmAdminPassword": {
              "type": "secureString"
            },
            "devOpsPat": {
              "type": "secureString"
            },
            "sshPublic": {
              "type": "secureString"
            }
          },
          "functions": [],
          "variables": {
            "Enviro": "[format('{0}{1}', parameters('Environment'), parameters('DeploymentID'))]",
            "Deployment": "[format('{0}-{1}-{2}-{3}', parameters('Prefix'), parameters('Global').orgname, parameters('Global').Appname, variables('Enviro'))]",
            "rg": "[format('{0}-{1}-{2}-RG-{3}', parameters('Prefix'), parameters('Global').orgname, parameters('Global').Appname, variables('Enviro'))]",
            "locationlookup": {
              "AZE2": "eastus2",
              "AZC1": "centralus",
              "AEU2": "eastus2",
              "ACU1": "centralus"
            },
            "location": "[variables('locationlookup')[parameters('Prefix')]]",
            "roleDefinitionsInfo": "[parameters('DeploymentInfo').RoleDefinitionsInfo]"
          },
          "resources": [
            {
              "copy": {
                "name": "roleDefinitions",
                "count": "[length(variables('roleDefinitionsInfo'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "[variables('roleDefinitionsInfo')[copyIndex()].RoleName]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "actions": {
                    "value": "[variables('roleDefinitionsInfo')[copyIndex()].actions]"
                  },
                  "assignableScopes": {
                    "value": "[if(contains(variables('roleDefinitionsInfo')[copyIndex()], 'assignableScopes'), variables('roleDefinitionsInfo')[copyIndex()].assignableScopes, array(null()))]"
                  },
                  "description": {
                    "value": "[variables('roleDefinitionsInfo')[copyIndex()].description]"
                  },
                  "notActions": {
                    "value": "[variables('roleDefinitionsInfo')[copyIndex()].notactions]"
                  },
                  "RoleName": {
                    "value": "[variables('roleDefinitionsInfo')[copyIndex()].RoleName]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1.14562",
                      "templateHash": "16559132920312721196"
                    }
                  },
                  "parameters": {
                    "RoleName": {
                      "type": "string"
                    },
                    "description": {
                      "type": "string"
                    },
                    "notActions": {
                      "type": "array"
                    },
                    "actions": {
                      "type": "array"
                    },
                    "assignableScopes": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleDefinitions",
                      "apiVersion": "2018-01-01-preview",
                      "name": "[guid(subscription().id, parameters('RoleName'))]",
                      "properties": {
                        "roleName": "[parameters('RoleName')]",
                        "description": "[parameters('description')]",
                        "permissions": [
                          {
                            "actions": "[parameters('actions')]",
                            "notActions": "[parameters('notActions')]"
                          }
                        ],
                        "assignableScopes": "[if(contains(parameters('assignableScopes'), null()), array(subscription().id), parameters('assignableScopes'))]"
                      }
                    }
                  ]
                }
              }
            }
          ],
          "outputs": {
            "Enviro": {
              "type": "string",
              "value": "[variables('Enviro')]"
            },
            "Deployment": {
              "type": "string",
              "value": "[variables('Deployment')]"
            },
            "location": {
              "type": "string",
              "value": "[variables('location')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('dp{0}-RG', variables('Deployment')))]"
      ]
    }
  ]
}